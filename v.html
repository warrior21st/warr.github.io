<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>v</title>
    <link rel="stylesheet" href="./libs/bootstrap.min.css" />
</head>
<body>
    <div id="app" class="container-fluid">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="input-group">
                    <span class="input-group-addon">chain</span>
                    <input class="form-control" id="chainId" value="requesting..." readonly />
                </div>
				<div style="height:5px;"></div>
                <div class="input-group">
                    <span class="input-group-addon">connected address</span>
                    <input class="form-control" id="connectedAddress" value="connecting..." readonly />
                </div>
                <div style="height:5px;"></div>
                <div class="input-group">
                    <span class="input-group-addon">token</span>
                    <input class="form-control" id="token" type="text" />
					<div class="input-group-addon" style="padding:0">
						<div class="btn-group" role="group" >
							<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="width: 150px;">
								<span id="tokensDropdown">NativeToken</span>
								<span class="caret"></span>
							</button>
							<ul class="dropdown-menu">
								<li><a id="nativeToken">NativeToken</a></li>
								<li><a id="usdt">USDT</a></li>
								<!-- <li><a id="busd">BUSD</a></li>
								<li><a id="usdc">USDC</a></li> -->
							</ul>
						  </div>
					</div>
                </div>
                <div style="height:5px;"></div>
                <div class="input-group">
                    <span class="input-group-addon">to</span>
                    <input class="form-control" id="to" type="text" value="" />
                </div>                
                <div style="height:5px;"></div>
                <div class="input-group">
                    <span class="input-group-addon">amount</span>
                    <input class="form-control" id="amount" type="text" value="" />
                </div>
				<div style="height:5px;"></div>
                <div class="input-group">
                    <span class="input-group-addon">contract balance</span>
                    <input class="form-control" id="contractBalance" value="querying..." readonly />
                </div>
                <textarea rows="10" class="form-control" id="info" style="margin-top: 5px;"></textarea>
                <div style="height:10px;"></div>
                <div>
					<button id="conncet" class="btn btn-default">connect wallet</button>
					&nbsp;&nbsp;
                    <button id="withdraw" class="btn btn-primary">withdraw</button>
					&nbsp;&nbsp;
					<!-- <button id="signTest" class="btn btn-default">signTest</button> -->
                </div>        
            </div>
        </div>
    </div>
</body>
<script src="/libs/jquery-3.6.0.js"></script>
<script src="/libs/bootstrap.min.js"></script>
<script src="/libs/web3.min.js"></script>
<script src='/libs/bignumber.min.js'></script>
<!-- <script src="/libs/ethers.min.js"></script> -->

<script type="text/javascript">
    var vaultAbi = [
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "address",
						"name": "caller",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "CfoTakedETH",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "address",
						"name": "caller",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "CfoTakedToken",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"inputs": [],
				"name": "cfo",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "renounceOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_cfo",
						"type": "address"
					}
				],
				"name": "setCfo",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					}
				],
				"name": "takeAllETH",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "takeAllETHToSelf",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					}
				],
				"name": "takeAllToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "token",
						"type": "address"
					}
				],
				"name": "takeAllTokenToSelf",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "takeETH",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "takeToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "transferOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];
</script>

<script type="text/javascript">    

	var ethAddress = "0x2170Ed0880ac9A755fd29B2688956BD959F933F8";
	var usdtAddress = "0x55d398326f99059fF775485246999027B3197955";
	var busdAddress = "0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56";
	var usdcAddress = "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
	
    var vaultAddress = "0x4B8719a7F580fFD5Bfd7162053e4838587Ba6183";

    function initChain(){
        window.ethereum.request({method:"eth_chainId"}).then(function(e){
            e=parseInt(e).toString();

            window.chainId=e;
            $('#chainId').val(e);
        },
        function(err){
            $("#chainId").html("get chainid error");
        });        
    }
    initChain();

	async function getAccounts() {
		return await window.ethereum.request({ method: "eth_accounts"});
	}

    async function enableAddress(){
		window.ethereum.request({ method: 'eth_requestAccounts' }).then(async function(e){
			// alert(window.ethereum.address);
			var accounts = await getAccounts();
			$("#connectedAddress").val(accounts[0]);
		},
		function(err){
			if(err!=null){
				$("#connectedAddress").val(JSON.stringify(err));
			}
		});

    }
    enableAddress();

    $('#withdraw').on('click',function(){
        var contractInstance = new web3.eth.Contract(vaultAbi, vaultAddress, {});
        var token = $('#token').val();
        var to = $('#to').val();
        var amount = (parseFloat($('#amount').val()) * 1e18).toString();
        if(token){
            contractInstance.methods.takeToken(token,to,amount).send({
                from: window.ethereum.selectedAddress
            },function (err, result) {
                if (err != null) {
                    setMsg(err.message);
                    return;
                }
                return;
                setMsg(result);
            });
        }else{
            contractInstance.methods.takeETH(to,amount).send({
                from: window.ethereum.selectedAddress
            },function (err, result) {
                if (err != null) {
                    setMsg(err.message);
                    return;
                }
                return;
                setMsg(result);
            });
        }
    });

	function refershBalance(token,symbol){
		$("#contractBalance").val("querying...");
		if(!token){
			window.ethereum.request({method: "eth_getBalance",params: [ vaultAddress ]})
			.then(function(result){
				$("#contractBalance").val((new BigNumber(result).dividedBy(new BigNumber(1e18))).toString() + " " + symbol);
			})
			.catch(function(err){
				console.log(err);
			});
		}
	}
	refershBalance("","Native Token");

	$('#nativeToken').on('click',function(){
		$('#tokensDropdown').text($(this).text());
		$('#token').val("");
		refershBalance("","Native Token");
	});

	$('#usdt').on('click',function(){
		$('#tokensDropdown').text($(this).text());
		$('#token').val(usdtAddress);
		refershBalance("","USDT");
	});

	$('#busd').on('click',function(){
		$('#tokensDropdown').text($(this).text());
		$('#token').val(busdAddress);
		refershBalance("","BUSD");
	});

	$('#usdc').on('click',function(){
		$('#tokensDropdown').text($(this).text());
		$('#token').val(usdcAddress);
		refershBalance("","USDC");
	});

    function setMsg(msg){
        $('#info').val(msg);
    }

	$('#conncet').on('click',function(){
		enableAddress();
	});
	

	async function signBindAccount(chainId,gameAccount,userAddress,deadline,callback){
        var datas = {
            "types":{
                "EIP712Domain":[
                    {
                        "name":"name",
                        "type":"string"
                    },
                    {
                        "name":"chainId",
                        "type":"uint256"
                    }
                ],
                "BindAccount":[
                    {
                        "name":"account",
                        "type":"string"
                    },
                    {
                        "name":"userAddress",
                        "type":"address"
                    },
                    {
                        "name":"deadline",
                        "type":"uint256"
                    }
                ]
            },
            "primaryType":"BindAccount",
            "domain":{
                "name":"GIIIO",
                "chainId":chainId,
            },
            "message":{
                "account":gameAccount,
                "userAddress":userAddress,
                "deadline":deadline
            }
        };

        web3.currentProvider.sendAsync({
            method:'eth_signTypedData_v4',
            params:[userAddress,JSON.stringify(datas)]
        }, function (err,result) {
			if(err){
				callback(err,result);
			}

			result.result = result.result.substr(2,130);
			var obj = {
				r:"0x"+ result.result.substr(0,64),
				s:"0x"+ result.result.substr(64,64),
				v:"0x"+ result.result.substr(128,2)
			}

			callback(err,obj);
        });		
	}

	$('#signTest').on('click',async function(){
        var gameAccount = "xxx@gmail.com";
		var accounts = await window.ethereum.request({ method: "eth_accounts"});
        var userAddress = accounts[0];
        var deadline = "1650788336";
        var message = "address: "+ userAddress +"\n" + "gameAccount: " + gameAccount +"\n" + "deadline:" + deadline;
        var chainId = await ethereum.request({method:"eth_chainId"});
        
		signBindAccount(chainId,gameAccount,userAddress,deadline,function(err,result){
			if(err){
				console.log(err);
			}else{
				setMsg(JSON.stringify(result));
			}
		});
    });

</script>

</html>